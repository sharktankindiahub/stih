<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - STIH</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet" />

  <!-- Stylesheets -->
  <link rel="stylesheet" href="../css/variables.css" />
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="css/admin.css" />
</head>

<body>
  <!-- Navigation -->
  <nav>
    <div class="logo" onclick="window.location.href='/'">
      <div class="logo-badge">STI</div>
      <div class="logo-text">SHARK TANK INDIA HUB</div>
    </div>
    <div style="color: var(--muted); font-size: 12px;">Admin Panel</div>
    <div style="display: flex; gap: 12px; align-items: center;">
      <!-- Theme Toggle -->
      <div class="theme-toggle">
        <button id="theme-light" class="theme-btn" onclick="adminTheme.set('light')" title="Light mode">‚òÄÔ∏è</button>
        <button id="theme-dark" class="theme-btn" onclick="adminTheme.set('dark')" title="Dark mode">üåô</button>
      </div>
      <button class="btn-outline btn-sm" onclick="adminLogout()">Logout</button>
    </div>
  </nav>

  <!-- Admin Container -->
  <div class="container section">
    <div style="margin-bottom: 48px;">
      <div class="display" style="font-size: clamp(40px, 7vw, 72px); margin-bottom: 12px;">Admin <span style="color: var(--red);">Dashboard</span></div>
      <p class="muted" style="font-size: 16px; line-height: 1.6;">Manage data synchronization and system settings.</p>
    </div>

    <!-- Data Sync Section -->
    <div class="card" style="margin-bottom: 32px;">
      <div class="card-title" style="font-size: 20px; margin-bottom: 12px;">Data Synchronization</div>
      <p class="muted" style="margin-bottom: 24px;">Reload data from Kaggle dataset. This will update all pitch, shark, and season information.</p>

      <div style="display: flex; gap: 12px; margin-bottom: 24px;">
        <button class="btn-primary" id="reload-btn" onclick="reloadDataFromKaggle()">üîÑ Reload Data from Kaggle</button>
        <button class="btn-outline" onclick="checkSyncStatus()">üìä Check Status</button>
        <button class="btn-outline" onclick="openMasterDataModal()">üìã View Master Data</button>
      </div>

      <!-- Status Box -->
      <div id="status-box" class="card" style="background: var(--card2); display: none;">
        <div class="label" style="margin-bottom: 8px;">Last Synchronization</div>
        <div id="sync-info" style="font-size: 14px; color: var(--text);"></div>
      </div>

      <!-- Progress Area -->
      <div id="progress-area" style="display: none;">
        <div style="margin-bottom: 12px;">
          <div class="label" style="margin-bottom: 8px;">Syncing in progress...</div>
          <div class="pbar">
            <div class="pbar-fill" style="width: 0%;" id="progress-bar"></div>
          </div>
        </div>
        <div id="progress-log" style="background: var(--card2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--muted); max-height: 200px; overflow-y: auto;"></div>
      </div>

      <!-- Error/Success Message -->
      <div id="sync-message" style="margin-top: 16px;"></div>
    </div>

    <!-- Settings Section -->
    <div class="card">
      <div class="card-title" style="font-size: 20px; margin-bottom: 12px;">System Information</div>
      <div id="system-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
          <div class="label" style="margin-bottom: 8px;">Server Status</div>
          <div style="color: var(--green);">üü¢ Online</div>
        </div>
        <div>
          <div class="label" style="margin-bottom: 8px;">Kaggle API Status</div>
          <div id="kaggle-status" style="color: var(--yellow);">‚è≥ Checking...</div>
        </div>
        <div>
          <div class="label" style="margin-bottom: 8px;">Data Files Location</div>
          <div style="color: var(--text); font-size: 12px;">src/data/</div>
        </div>
        <div>
          <div class="label" style="margin-bottom: 8px;">Python Script</div>
          <div style="color: var(--text); font-size: 12px;">scripts/fetch_kaggle_data.py</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Master Data Modal -->
  <div id="master-data-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
    <div class="modal-content" style="background: var(--bg); border-radius: 12px; max-width: 95vw; max-height: 95vh; margin: 2.5vh auto; padding: 24px; overflow: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px;">Master Data from Kaggle</h2>
        <button onclick="closeMasterDataModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text);">‚úï</button>
      </div>

      <!-- Controls Row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">üìÅ Select Backup File</label>
          <select id="backup-file-select" onchange="loadBackupFile()" style="width: 100%; padding: 8px; background: var(--card2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; cursor: pointer;">
            <option value="">Latest Data (Current)</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">üìä Raw Kaggle CSV</label>
          <div style="display: flex; gap: 8px;">
            <select id="raw-csv-select" onchange="loadRawCsvFile()" style="flex: 1; padding: 8px; background: var(--card2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; cursor: pointer; display: none;">
              <option value="">Select Raw Data File</option>
            </select>
            <button onclick="openRawDataViewer()" style="padding: 8px 16px; background: var(--secondary); border: 1px solid var(--secondary); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">üìë Open Full Page</button>
          </div>
        </div>
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">üé¨ Filter by Season</label>
          <select id="season-filter" onchange="applyFilters()" style="width: 100%; padding: 8px; background: var(--card2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; cursor: pointer; display: none;">
            <option value="">All Seasons</option>
          </select>
        </div>
      </div>

      <!-- Data Type Tabs -->
      <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap;">
        <button class="data-tab active" onclick="switchDataTab('pitches', this)" style="padding: 12px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid var(--primary); color: var(--primary);">Pitches</button>
        <button class="data-tab" onclick="switchDataTab('sharks', this)" style="padding: 12px 16px; border: none; background: none; cursor: pointer; color: var(--muted);">Sharks</button>
        <button class="data-tab" onclick="switchDataTab('seasons', this)" style="padding: 12px 16px; border: none; background: none; cursor: pointer; color: var(--muted);">Seasons</button>
        <button class="data-tab" onclick="switchDataTab('industries', this)" style="padding: 12px 16px; border: none; background: none; cursor: pointer; color: var(--muted);">Industries</button>
        <button class="data-tab" onclick="switchDataTab('raw_csv', this)" style="padding: 12px 16px; border: none; background: none; cursor: pointer; color: var(--muted);">üîç Raw CSV</button>
      </div>

      <!-- View Format Buttons -->
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <label style="font-size: 12px; color: var(--muted); line-height: 32px; margin-right: auto;">üìä View Format:</label>
        <button onclick="setViewFormat('table')" class="view-format-btn active" data-format="table" style="padding: 8px 16px; background: var(--primary); border: 1px solid var(--primary); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">üìä Table</button>
        <button onclick="setViewFormat('json')" class="view-format-btn" data-format="json" style="padding: 8px 16px; background: var(--card2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; cursor: pointer;">{} JSON</button>
      </div>

      <!-- Data Display Area -->
      <div id="data-display" style="background: var(--card2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; max-height: 65vh; overflow: auto; font-size: 12px; color: var(--text);"></div>

      <!-- Stats Footer -->
      <div id="data-stats" style="margin-top: 16px; padding: 12px; background: var(--card2); border-radius: 8px; font-size: 12px; color: var(--muted);"></div>
    </div>
  </div>

  <script>
    // Theme management for admin pages
    const adminTheme = {
      STORAGE_KEY: 'stih-theme',
      DARK_CLASS: 'dark',
      DEFAULT: 'dark',

      init() {
        const saved = localStorage.getItem(this.STORAGE_KEY) || this.DEFAULT;
        this.set(saved);
        this.updateToggleUI();
      },

      set(mode) {
        const html = document.documentElement;
        if (mode === 'light') {
          html.classList.add('light');
        } else {
          html.classList.remove('light');
        }
        localStorage.setItem(this.STORAGE_KEY, mode);
        this.updateToggleUI();
      },

      getCurrent() {
        return document.documentElement.classList.contains('light') ? 'light' : 'dark';
      },

      updateToggleUI() {
        const current = this.getCurrent();
        const darkBtn = document.getElementById('theme-dark');
        const lightBtn = document.getElementById('theme-light');

        if (darkBtn && lightBtn) {
          if (current === 'dark') {
            darkBtn.classList.add('active');
            lightBtn.classList.remove('active');
          } else {
            lightBtn.classList.add('active');
            darkBtn.classList.remove('active');
          }
        }
      }
    };

    // Check auth
    const token = localStorage.getItem('adminToken');
    if (!token) {
      window.location.href = '/admin/login.html';
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', () => {
      adminTheme.init();
      checkSyncStatus();
    });

    async function checkSyncStatus() {
      try {
        const response = await fetch('/api/admin/status', {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch status');
        }

        const data = await response.json();
        const statusBox = document.getElementById('status-box');
        const syncInfo = document.getElementById('sync-info');

        // Update Kaggle API status
        if (data.kaggleStatus) {
          const kaggleStatusEl = document.getElementById('kaggle-status');
          if (data.kaggleStatus.status === 'online') {
            kaggleStatusEl.innerHTML = 'üü¢ Online';
            kaggleStatusEl.style.color = 'var(--green)';
          } else {
            kaggleStatusEl.innerHTML = 'üî¥ Offline';
            kaggleStatusEl.style.color = 'var(--red)';
          }
          kaggleStatusEl.title = data.kaggleStatus.message;
        }

        if (data.lastSyncAt) {
          const date = new Date(data.lastSyncAt);
          syncInfo.innerHTML = `
            <div><strong>Last Sync:</strong> ${date.toLocaleString('en-IN')}</div>
            <div><strong>Status:</strong> ${data.status}</div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
              Records: Pitches (${data.recordsImported?.pitches || 0}) | Sharks (${data.recordsImported?.sharks || 0}) | Seasons (${data.recordsImported?.seasons || 0})
            </div>
          `;
          statusBox.style.display = 'block';
        } else {
          syncInfo.innerHTML = '<div class="muted">No sync data available</div>';
          statusBox.style.display = 'block';
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function reloadDataFromKaggle() {
      const btn = document.getElementById('reload-btn');
      const progressArea = document.getElementById('progress-area');
      const progressBar = document.getElementById('progress-bar');
      const progressLog = document.getElementById('progress-log');
      const syncMessage = document.getElementById('sync-message');

      btn.disabled = true;
      progressArea.style.display = 'block';
      syncMessage.innerHTML = '';

      try {
        const response = await fetch('/api/admin/reload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Reload failed');
        }

        // Simulate progress
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 30;
          if (progress > 100) progress = 100;
          progressBar.style.width = progress + '%';
          if (progress === 100) clearInterval(interval);
        }, 500);

        progressLog.innerHTML += `<div>‚úÖ Data reload initiated...</div>`;
        progressLog.innerHTML += `<div>${data.message || 'Sync successful'}</div>`;

        syncMessage.innerHTML = '<div class="success-message">‚úÖ Data reloaded successfully!</div>';

        // Refresh status
        setTimeout(() => {
          checkSyncStatus();
        }, 2000);
      } catch (error) {
        progressLog.innerHTML += `<div style="color: var(--red);">‚ùå Error: ${error.message}</div>`;
        syncMessage.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
      }
    }

    function adminLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('adminToken');
        window.location.href = '/admin/login.html';
      }
    }

    // Master Data Modal Functions
    let masterData = {};
    let originalData = {};
    let rawCsvData = {};
    let currentDataTab = 'pitches';
    let viewFormat = 'table';

    async function openMasterDataModal() {
      const modal = document.getElementById('master-data-modal');
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'flex-start';

      // Fetch all data, backup files, and raw CSV files
      try {
        const [pitches, sharks, seasons, analytics, backupFiles, rawCsvFiles] = await Promise.all([
          fetch('/api/pitches').then(r => r.json()),
          fetch('/api/sharks').then(r => r.json()),
          fetch('/api/seasons').then(r => r.json()),
          fetch('/api/analytics').then(r => r.json()),
          fetch('/api/admin/backup-files').then(r => r.json()),
          fetch('/api/admin/raw-csv-files').then(r => r.json()).catch(() => ({ files: [] })),
        ]);

        masterData = { pitches, sharks, seasons, industries: analytics.industries || [] };
        originalData = JSON.parse(JSON.stringify(masterData)); // Deep copy

        // Populate backup file selector
        const select = document.getElementById('backup-file-select');
        const existingOptions = Array.from(select.options).length > 1 
          ? Array.from(select.options).slice(1) 
          : [];
        existingOptions.forEach(opt => opt.remove());

        if (backupFiles.files && backupFiles.files.length > 0) {
          backupFiles.files.forEach(file => {
            const option = document.createElement('option');
            option.value = file.name;
            option.textContent = `${file.name} (${file.timestamp})`;
            select.appendChild(option);
          });
        }

        // Populate raw CSV file selector
        const rawCsvSelect = document.getElementById('raw-csv-select');
        rawCsvSelect.innerHTML = '<option value="">Select Raw Data File</option>';
        if (rawCsvFiles.files && rawCsvFiles.files.length > 0) {
          rawCsvFiles.files.forEach(file => {
            const option = document.createElement('option');
            option.value = file.name;
            option.textContent = `${file.name.replace('kaggle_raw_', '')} (${file.timestamp})`;
            rawCsvSelect.appendChild(option);
          });
        }

        // Populate season filter
        const seasonFilter = document.getElementById('season-filter');
        seasonFilter.innerHTML = '<option value="">All Seasons</option>';
        seasons.forEach(season => {
          const option = document.createElement('option');
          option.value = season.name || season.season;
          option.textContent = season.name || season.season;
          seasonFilter.appendChild(option);
        });

        switchDataTab('pitches');
      } catch (error) {
        document.getElementById('data-display').innerHTML = '‚ùå Error loading data: ' + error.message;
      }
    }

    function closeMasterDataModal() {
      document.getElementById('master-data-modal').style.display = 'none';
    }

    async function loadBackupFile() {
      const filename = document.getElementById('backup-file-select').value;
      try {
        if (!filename) {
          // Reload current data
          const [pitches, sharks, seasons, analytics] = await Promise.all([
            fetch('/api/pitches').then(r => r.json()),
            fetch('/api/sharks').then(r => r.json()),
            fetch('/api/seasons').then(r => r.json()),
            fetch('/api/analytics').then(r => r.json()),
          ]);
          masterData = { pitches, sharks, seasons, industries: analytics.industries || [] };
        } else {
          const response = await fetch(`/api/admin/backup-data/${filename}`);
          if (!response.ok) throw new Error('Failed to load backup file');
          const result = await response.json();
          masterData = result.data;
        }
        originalData = JSON.parse(JSON.stringify(masterData)); // Deep copy
        document.getElementById('season-filter').value = ''; // Reset season filter
        switchDataTab(currentDataTab);
      } catch (error) {
        alert('Error loading backup: ' + error.message);
      }
    }

    async function loadRawCsvFile() {
      const filename = document.getElementById('raw-csv-select').value;
      try {
        if (!filename) {
          rawCsvData = {};
          return;
        }

        const response = await fetch(`/api/admin/raw-csv-data/${filename}`);
        if (!response.ok) throw new Error('Failed to load raw CSV file');
        const result = await response.json();
        rawCsvData = result.data || [];
        
        switchDataTab('raw_csv');
      } catch (error) {
        alert('Error loading raw CSV: ' + error.message);
      }
    }

    function openRawDataViewer() {
      const filename = document.getElementById('raw-csv-select').value || 'kaggle_raw_latest.csv';
      window.open(`/admin/raw-data-viewer.html?file=${encodeURIComponent(filename)}`, '_blank', 'width=1600,height=900');
    }

    function setViewFormat(format) {
      viewFormat = format;
      document.querySelectorAll('.view-format-btn').forEach(btn => {
        btn.style.background = btn.dataset.format === format ? 'var(--primary)' : 'var(--card2)';
        btn.style.color = btn.dataset.format === format ? 'white' : 'var(--text)';
        btn.style.borderColor = btn.dataset.format === format ? 'var(--primary)' : 'var(--border)';
      });
      applyFilters();
    }

    function applyFilters() {
      const seasonValue = document.getElementById('season-filter').value;
      
      if (currentDataTab === 'pitches' && seasonValue) {
        const filtered = originalData.pitches.filter(pitch => {
          return pitch.season === seasonValue || pitch.season === parseInt(seasonValue);
        });
        masterData.pitches = filtered;
      } else {
        masterData = JSON.parse(JSON.stringify(originalData)); // Reset to original
      }
      
      displayData();
    }

    function switchDataTab(tabName, buttonEl) {
      currentDataTab = tabName;
      
      // Show/hide controls based on tab
      document.getElementById('season-filter').style.display = (tabName === 'pitches') ? 'block' : 'none';
      document.getElementById('raw-csv-select').style.display = (tabName === 'raw_csv') ? 'block' : 'none';
      
      // Update tab UI
      document.querySelectorAll('.data-tab').forEach(tab => {
        tab.style.color = 'var(--muted)';
        tab.style.borderBottom = 'none';
      });
      if (buttonEl) {
        buttonEl.style.color = 'var(--primary)';
        buttonEl.style.borderBottom = '2px solid var(--primary)';
      }

      applyFilters();
    }

    function displayData() {
      const displayArea = document.getElementById('data-display');
      const statsArea = document.getElementById('data-stats');
      
      // Handle raw CSV data
      if (currentDataTab === 'raw_csv') {
        const data = rawCsvData || [];
        
        if (!Array.isArray(data) || data.length === 0) {
          displayArea.innerHTML = '<div style="color: var(--muted);">Select a raw CSV file to view data</div>';
          statsArea.innerHTML = `<strong>RAW CSV:</strong> 0 records | All original columns from Kaggle`;
          return;
        }

        let html = '';
        if (viewFormat === 'table') {
          html = generateTableView(data);
        } else {
          html = '<pre style="margin: 0; overflow-x: auto;">' + JSON.stringify(data, null, 2) + '</pre>';
        }

        displayArea.innerHTML = html;
        statsArea.innerHTML = `<strong>RAW CSV:</strong> ${data.length} records | ${Object.keys(data[0] || {}).length} columns from Kaggle`;
        return;
      }

      // Handle processed data
      const data = masterData[currentDataTab] || [];
      
      if (!Array.isArray(data) || data.length === 0) {
        displayArea.innerHTML = '<div style="color: var(--muted);">No data available</div>';
        statsArea.innerHTML = `<strong>${currentDataTab.toUpperCase()}:</strong> 0 records`;
        return;
      }

      let html = '';
      if (viewFormat === 'table') {
        html = generateTableView(data);
      } else {
        html = '<pre style="margin: 0; overflow-x: auto;">' + JSON.stringify(data, null, 2) + '</pre>';
      }

      displayArea.innerHTML = html;
      statsArea.innerHTML = `<strong>${currentDataTab.toUpperCase()}:</strong> ${data.length} records | Format: ${viewFormat.toUpperCase()}`;
    }

    function generateTableView(data) {
      if (!Array.isArray(data) || data.length === 0) return 'No data';

      let html = '<table style="width: 100%; border-collapse: collapse; font-size: 11px;">';
      
      // Get column names from first record
      const firstRecord = data[0];
      const columns = Object.keys(firstRecord).slice(0, 8); // Limit to 8 columns for readability

      // Table header
      html += '<tr style="background: var(--card1); border-bottom: 2px solid var(--border);">';
      columns.forEach(col => {
        html += `<th style="padding: 8px; text-align: left; border: 1px solid var(--border); font-weight: 600;">${col}</th>`;
      });
      html += '</tr>';

      // Table rows
      data.forEach((row, idx) => {
        html += `<tr style="background: ${idx % 2 === 0 ? 'var(--card1)' : 'var(--card2)'}; border-bottom: 1px solid var(--border);">`;
        columns.forEach(col => {
          let value = row[col];
          // Format value for display
          if (value === null || value === undefined) {
            value = '‚Äî';
          } else if (typeof value === 'object') {
            value = Array.isArray(value) ? `[${value.length} items]` : '{object}';
          } else if (typeof value === 'string' && value.length > 50) {
            value = value.substring(0, 47) + '...';
          }
          html += `<td style="padding: 8px; border: 1px solid var(--border); color: var(--text);">${value}</td>`;
        });
        html += '</tr>';
      });

      html += '</table>';
      return html;
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('master-data-modal');
      if (e.target === modal) {
        closeMasterDataModal();
      }
    });

    // Load status on init
    window.addEventListener('load', () => {
      checkSyncStatus();
    });
  </script>
</body>
</html>
